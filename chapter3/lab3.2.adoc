# Usare `nsenter` per smascherare comandi alterati nei container

Questo documento mostra **perch√© e come usare `nsenter`** per eseguire comandi **dal nodo host** invece di affidarsi ai binari presenti nel container.

Lo scenario dimostra un caso volutamente *malevolo*: il comando `ps` all'interno di un container viene **sostituito (hackerato)**. Usando `nsenter`, eseguiamo invece il `ps` del nodo, entrando nei namespace del container, e otteniamo la **verit√† sui processi in esecuzione**.

---

## Scenario

* Container basato su **UBI9**
* Il comando `ps` nel container viene sovrascritto con uno script fasullo
* Dal container e da `oc exec` il risultato √® falsato
* Dal nodo, usando `nsenter`, otteniamo il risultato reale

---

## 1Ô∏è‚É£ Login come amministratore OpenShift

> Serve essere **cluster-admin** per accedere ai nodi.

```bash
# Login come admin
oc login -u admin -p redhat ocp
```

---

## 2Ô∏è‚É£ Avvio di un container UBI9 interattivo

> Creiamo un pod temporaneo per eseguire i test.

```bash
oc run ubi9-command -it \
  --image registry.ocp4.example.com:8443/ubi9/ubi \
  -- /bin/bash
```

Ora siamo **dentro il container**.

---

## 3Ô∏è‚É£ Creazione di un comando `ps` fasullo nel container

> Simuliamo un attacco: il binario `ps` viene sostituito.

```bash
# Creiamo una directory per i binari falsi
mkdir -p /tmp/fakebin
```

```bash
# Creiamo uno script che si spaccia per 'ps'
cat <<'EOF' > /tmp/fakebin/ps
#!/bin/sh
echo "Sei stato hackerato! Non ti faccio vedere i processi!"
EOF
```

```bash
# Rendiamo eseguibile il comando fasullo
chmod +x /tmp/fakebin/ps
```

```bash
# Sovrascriviamo il vero ps con un symlink malevolo
ln -sf /tmp/fakebin/ps /usr/bin/ps
```

---

## 4Ô∏è‚É£ Verifica: il comando `ps` √® compromesso

```bash
ps
```

Output:

```text
Sei stato hackerato! Non ti faccio vedere i processi!
```

üëâ **Il container non mostra pi√π i processi reali.**

Manteniamo il container in vita:

```bash
sleep infinity
```

---

## 5Ô∏è‚É£ Test da un altro terminale con `oc exec`

> Anche da fuori dal container, il comando rimane compromesso.

```bash
oc exec ubi9-command ps
```

Output:

```text
Sei stato hackerato! Non ti faccio vedere i processi!
```

üëâ `oc exec` **usa i binari del container**, quindi non √® affidabile in caso di compromissione.

---

## 6Ô∏è‚É£ Accesso al nodo OpenShift

> Ora passiamo al nodo per eseguire i comandi **dal sistema host**.

```bash
oc debug node/master01
```

```bash
# Entriamo nel filesystem del nodo
chroot /host
```

Da qui in poi **stiamo operando sul nodo**, non nel container.

---

## 7Ô∏è‚É£ Individuazione del PID reale del container

> Usiamo `crictl` per trovare il processo del container.

```bash
CID=$(crictl ps --name ubi9-command -o json | jq -r .containers[0].id)
```

```bash
# Ispezioniamo il container per trovare il PID
crictl inspect "$CID" | grep pid
```

Oppure direttamente:

```bash
PID=$(crictl inspect "$CID" | jq -r '.info.pid')
```

> Se `jq` non √® disponibile, copia il PID manualmente dall'output di `crictl inspect`.

---

## 8Ô∏è‚É£ Uso di `nsenter` per entrare nei namespace del container

> Qui sta il punto chiave: **usiamo i binari del nodo**, ma nei namespace del container.

```bash
nsenter --target $PID --pid bash -c 'ps -ef'
```

### üîç Cosa succede davvero

* `nsenter` usa il **ps del nodo host**
* Entra nel **PID namespace del container**
* Ignora completamente il `ps` hackerato nel filesystem del container

üëâ **Questo √® l'elenco reale dei processi del container.**

---

## üéØ Conclusioni

* ‚ùå I comandi eseguiti **dentro il container** possono essere alterati
* ‚ùå `oc exec` **non √® affidabile** in caso di compromissione
* ‚úÖ `nsenter` permette di:

  * usare strumenti fidati del nodo
  * entrare nei namespace del container
  * ottenere informazioni attendibili

üëâ **Per troubleshooting avanzato e sicurezza, `nsenter` √® lo strumento corretto.**

---

## üìå Messaggio chiave

> **Non fidarti mai dei binari di un container compromesso.**
> Se vuoi la verit√†, entra dai namespace usando gli strumenti del nodo.

---

Se vuoi, nel prossimo passo posso:

* trasformare questo esempio in **laboratorio didattico**
* aggiungere una sezione **"perch√© `oc exec` non basta"**
* estendere l'esempio a `/proc`, `/net` o mount namespace
